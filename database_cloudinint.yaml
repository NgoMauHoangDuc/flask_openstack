#cloud-config
# Database Server Cloud-Init Configuration

users:
  - name: dbadmin
    groups: sudo
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    ssh-authorized-keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC69ejkhXiSNAfW/oUSA3u8zEB7sCYCKcAT5PrQ8e2cV8Sp9vTxHwG06h+H+W/thVqRffZVkFBWYORAH16Im0fmyOLfTEee/knEXzi4Yq+War442Wm/GMF2tXSpVToD+17k113m2hhtVYsQxW6bB9e/HgnNq0lv9Syh0bvtvaevZ2RKr70MtssSs9/0OglI6LdgVgv6GKWz0Yj10XYwOxP48zZIinO8Q+azedIGm1Pgkvkp3t16IGWV0xkqu2KTRhTSziPxITKzb7B/bgGNExZ3ucJcVDueN3kKHAUk4kUQqh2Tp2TSAdmzxp2DgnVSmviiy1bzIiqsKvYdRSycx7LZ Generated-by-Nova

packages:
  - mysql-server

package_update: true
package_upgrade: true

write_files:
  - path: /etc/mysql/mysql.conf.d/mysqld.cnf
    permissions: '0644'
    content: |
      [mysqld]
      pid-file        = /var/run/mysqld/mysqld.pid
      socket          = /var/run/mysqld/mysqld.sock
      datadir         = /var/lib/mysql
      log-error       = /var/log/mysql/error.log
      bind-address    = 0.0.0.0
      mysqlx-bind-address = 0.0.0.0
      max_connections = 200
      character-set-server = utf8mb4
      collation-server = utf8mb4_unicode_ci

runcmd:
  - systemctl start mysql
  - systemctl enable mysql
  - sleep 5
  - mysql -e "CREATE DATABASE IF NOT EXISTS flaskdb CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"
  - mysql -e "CREATE USER IF NOT EXISTS 'flaskuser'@'%' IDENTIFIED BY 'FlaskPass123';"
  - mysql -e "GRANT ALL PRIVILEGES ON flaskdb.* TO 'flaskuser'@'%';"
  - mysql -e "FLUSH PRIVILEGES;"
  - systemctl restart mysql

final_message: "Database server deployed successfully. MySQL is listening on port 3306"